<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Shared core and types - Crux: Cross-platform app development in Rust</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../././mdbook-admonish.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../overview.html">Overview</a></li><li class="chapter-item expanded affix "><a href="../motivation.html">Motivation</a></li><li class="chapter-item expanded affix "><li class="part-title">Getting Started</li><li class="chapter-item expanded "><a href="../getting_started/core.html" class="active"><strong aria-hidden="true">1.</strong> Shared core and types</a></li><li class="chapter-item expanded "><a href="../getting_started/ios.html"><strong aria-hidden="true">2.</strong> iOS — Swift and SwiftUI</a></li><li class="chapter-item expanded "><a href="../getting_started/android.html"><strong aria-hidden="true">3.</strong> Android — Kotlin and Jetpack Compose</a></li><li class="chapter-item expanded "><a href="../getting_started/web_react.html"><strong aria-hidden="true">4.</strong> Web — TypeScript and React (Next.js)</a></li><li class="chapter-item expanded "><a href="../getting_started/web_yew.html"><strong aria-hidden="true">5.</strong> Web — Rust and Yew</a></li><li class="chapter-item expanded affix "><li class="part-title">Development Guide</li><li class="chapter-item expanded "><a href="../guide/hello_world.html"><strong aria-hidden="true">6.</strong> Hello world</a></li><li class="chapter-item expanded "><a href="../guide/elm_architecture.html"><strong aria-hidden="true">7.</strong> Elm Architecture</a></li><li class="chapter-item expanded "><a href="../guide/capabilities.html"><strong aria-hidden="true">8.</strong> Capabilities</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../guide/capability_apis.html"><strong aria-hidden="true">8.1.</strong> Capability APIs</a></li></ol></li><li class="chapter-item expanded "><a href="../guide/message_interface.html"><strong aria-hidden="true">9.</strong> Message interface between core and shell</a></li><li class="chapter-item expanded "><a href="../guide/composing.html"><strong aria-hidden="true">10.</strong> Composable Applications</a></li><li class="chapter-item expanded affix "><li class="part-title">Internals</li><li class="chapter-item expanded "><a href="../internals/uniffi.html"><strong aria-hidden="true">11.</strong> FFI interface</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../internals/core_api.html"><strong aria-hidden="true">11.1.</strong> Core API</a></li><li class="chapter-item expanded "><a href="../internals/typegen.html"><strong aria-hidden="true">11.2.</strong> Type generation</a></li></ol></li><li class="chapter-item expanded "><a href="../internals/serialization.html"><strong aria-hidden="true">12.</strong> Serialization</a></li><li class="chapter-item expanded "><a href="../internals/continuations.html"><strong aria-hidden="true">13.</strong> Continuations</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Crux: Cross-platform app development in Rust</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/redbadger/crux/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/redbadger/crux/edit/master/docs/src/getting_started/core.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="shared-core-and-types"><a class="header" href="#shared-core-and-types">Shared core and types</a></h1>
<p>These are the steps to set up the two crates forming the shared core – the core itself, and the shared types crate which does type generation for the foreign languages.</p>
<div id="admonition-sharp-edge" class="admonition warning">
<div class="admonition-title">
<p>Sharp edge</p>
<p><a class="admonition-anchor-link" href="#admonition-sharp-edge"></a></p>
</div>
<div>
<p>Most of these steps are going to be automated in future tooling, and published as crates. For now the set up is effectively a copy &amp; paste from one of the <a href="https://github.com/redbadger/crux/tree/master/examples">example projects</a>.</p>
</div>
</div>
<h2 id="install-the-tools"><a class="header" href="#install-the-tools">Install the tools</a></h2>
<p>This is an example of a <a href="https://rust-lang.github.io/rustup/overrides.html#the-toolchain-file"><code>rust-toolchain.toml</code></a> file, which you can add at the root of your repo. It should ensure that the correct rust channel and compile targets are installed automatically for you when you use any rust tooling within the repo.</p>
<!--- includes fail when indented see https://github.com/rust-lang/mdBook/pull/1718 --->
<pre><code class="language-toml">[toolchain]
channel = &quot;stable&quot;
components = [&quot;rustfmt&quot;, &quot;rustc-dev&quot;]
targets = [
  &quot;aarch64-apple-darwin&quot;,
  &quot;aarch64-apple-ios&quot;,
  &quot;aarch64-apple-ios-sim&quot;,
  &quot;aarch64-linux-android&quot;,
  &quot;wasm32-unknown-unknown&quot;,
  &quot;x86_64-apple-ios&quot;
]
profile = &quot;minimal&quot;
</code></pre>
<h2 id="create-the-core-crate"><a class="header" href="#create-the-core-crate">Create the core crate</a></h2>
<h3 id="the-shared-library"><a class="header" href="#the-shared-library">The shared library</a></h3>
<p>The first library to create is the one that will be shared across all platforms, containing the <em>behavior</em> of the app. You can call it whatever you like, but we have chosen the name <code>shared</code> here.
You can create the shared rust library, like this:</p>
<pre><code class="language-sh">cargo new --lib shared
</code></pre>
<h3 id="the-workspace-and-library-manifests"><a class="header" href="#the-workspace-and-library-manifests">The workspace and library manifests</a></h3>
<p>We'll be adding a bunch of other folders into the monorepo, so we are choosing to use Cargo Workspaces. Edit the workspace <code>/Cargo.toml</code> file, at the monorepo root, to add the new library to our workspace. It should look something like this (the <code>package</code> and <code>dependencies</code> fields are just examples):</p>
<pre><code class="language-toml">[workspace]
members = [&quot;shared&quot;, &quot;shared_types&quot;]

[workspace.package]
authors = [&quot;Red Badger Consulting Limited&quot;]
edition = &quot;2021&quot;
repository = &quot;https://github.com/redbadger/crux/&quot;
license = &quot;Apache-2.0&quot;
keywords = [&quot;crux&quot;, &quot;crux_core&quot;, &quot;cross-platform-ui&quot;, &quot;ffi&quot;, &quot;wasm&quot;]
rust-version = &quot;1.66&quot;

[workspace.dependencies]
anyhow = &quot;1.0.69&quot;
serde = &quot;1.0.152&quot;
</code></pre>
<p>The library's manifest, at <code>/shared/Cargo.toml</code>, should look something like the following, but there are a few things to note:</p>
<ul>
<li>the <code>crate-type</code>
<ul>
<li><code>lib</code> is the default rust library when linking into a rust binary, e.g. in the <code>web-yew</code>, or <code>cli</code>, variant</li>
<li><code>staticlib</code> is a static library (<code>libshared.a</code>) for including in the Swift iOS app variant</li>
<li><code>cdylib</code> is a C-ABI dynamic library (<code>libshared.so</code>) for use with JNA when included in the Kotlin Android app variant</li>
</ul>
</li>
<li>the <code>path</code> fields on the crux dependencies are for the <a href="https://github.com/redbadger/crux/tree/master/examples">examples in the Crux repo</a> and so you will probably not need them</li>
<li>the uniffi dependencies and <code>uniffi-bindgen</code> target should make sense after you read the next section</li>
</ul>
<pre><code class="language-toml">[package]
name = &quot;shared&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;
rust-version = &quot;1.66&quot;

[lib]
crate-type = [&quot;lib&quot;, &quot;staticlib&quot;, &quot;cdylib&quot;]
name = &quot;shared&quot;

[dependencies]
crux_core = { version = &quot;0.3&quot;, path = &quot;../../../crux_core&quot; }
crux_macros = { version = &quot;0.1&quot;, path = &quot;../../../crux_macros&quot; }
serde = { workspace = true, features = [&quot;derive&quot;] }
lazy_static = &quot;1.4.0&quot;
uniffi = &quot;0.23.0&quot;
wasm-bindgen = &quot;0.2.84&quot;

[target.uniffi-bindgen.dependencies]
uniffi = { version = &quot;0.23.0&quot;, features = [&quot;cli&quot;] }

[build-dependencies]
uniffi = { version = &quot;0.23.0&quot;, features = [&quot;build&quot;] }
</code></pre>
<h3 id="ffi-bindings"><a class="header" href="#ffi-bindings">FFI bindings</a></h3>
<p>Crux uses Mozilla's <a href="https://mozilla.github.io/uniffi-rs/">Uniffi</a> to generate the FFI bindings for iOS and Android.</p>
<h4 id="generating-the-uniffi-bindgen-cli-tool"><a class="header" href="#generating-the-uniffi-bindgen-cli-tool">Generating the <code>uniffi-bindgen</code> CLI tool</a></h4>
<p>Since Mozilla released version <code>0.23.0</code> of Uniffi, we need to also generate the binary that generates these bindings. This avoids the possibility of getting a version mismatch between a separately installed binary and the crate's Uniffi version. You can read more about it <a href="https://mozilla.github.io/uniffi-rs/tutorial/foreign_language_bindings.html">here</a>.</p>
<p>Generating the binary is simple, we just add the following to our crate, in a file called <code>/shared/src/bin/uniffi-bindgen.rs</code>.</p>
<pre><pre class="playground"><code class="language-rust">fn main() {
    uniffi::uniffi_bindgen_main()
}</code></pre></pre>
<p>And then we can build it with cargo.</p>
<pre><code class="language-sh">cargo run -p shared --bin uniffi-bindgen

# or

cargo build
./target/debug/uniffi-bindgen
</code></pre>
<p>The <code>uniffi-bindgen</code> executable will be used during the build in XCode and in Android Studio (see the following pages).</p>
<h4 id="the-interface-definitions"><a class="header" href="#the-interface-definitions">The interface definitions</a></h4>
<p>We will need an interface definition file for the FFI bindings. Uniffi has its own file format (similar to WebIDL) that has a <code>.udl</code> extension. You can create one here <code>/shared/src/shared.udl</code>, like this:</p>
<pre><code class="language-txt">namespace shared {
  sequence&lt;u8&gt; process_event([ByRef] sequence&lt;u8&gt; msg);
  sequence&lt;u8&gt; handle_response([ByRef] sequence&lt;u8&gt; uuid, [ByRef] sequence&lt;u8&gt; res);
  sequence&lt;u8&gt; view();
};
</code></pre>
<p>There are also a few additional parameters to tell Uniffi how to create bindings for Kotlin and Swift. They live in the file <code>/shared/uniffi.toml</code>, like this (feel free to adjust accordingly):</p>
<pre><code class="language-toml">[bindings.kotlin]
package_name = &quot;com.example.counter.shared&quot;
cdylib_name = &quot;shared&quot;

[bindings.swift]
cdylib_name = &quot;shared_ffi&quot;
omit_argument_labels = true
</code></pre>
<h3 id="scaffolding"><a class="header" href="#scaffolding">Scaffolding</a></h3>
<p>Soon we will have macros and/or code-gen to help with this, but for now, we need some scaffolding in <code>/shared/src/lib.rs</code>. You'll notice that we are re-exporting the <code>Request</code> type and the capabilities we want to use in our native Shells, as well as our public types from the shared library.</p>
<pre><code class="language-rust noplayground">pub mod app;
pub mod capabilities;

use lazy_static::lazy_static;
use wasm_bindgen::prelude::wasm_bindgen;

use crux_core::Core;
pub use crux_core::Request;
pub use crux_http as http;

pub use app::*;
pub use capabilities::sse;

// TODO hide this plumbing

uniffi::include_scaffolding!(&quot;shared&quot;);

lazy_static! {
    static ref CORE: Core&lt;Effect, App&gt; = Core::new::&lt;Capabilities&gt;();
}

#[wasm_bindgen]
pub fn process_event(data: &amp;[u8]) -&gt; Vec&lt;u8&gt; {
    CORE.process_event(data)
}

#[wasm_bindgen]
pub fn handle_response(uuid: &amp;[u8], data: &amp;[u8]) -&gt; Vec&lt;u8&gt; {
    CORE.handle_response(uuid, data)
}

#[wasm_bindgen]
pub fn view() -&gt; Vec&lt;u8&gt; {
    CORE.view()
}</code></pre>
<h3 id="the-app"><a class="header" href="#the-app">The app</a></h3>
<p>Now we are in a position to create a basic app in <code>/shared/src/app.rs</code>. This is from the <a href="https://github.com/redbadger/crux/blob/master/examples/hello_world/shared/src/counter.rs">simple Counter example</a> (which also has tests, although we're not showing them here):</p>
<pre><code class="language-rust noplayground">use crux_core::{render::Render, App};
use crux_macros::Effect;
use serde::{Deserialize, Serialize};

#[derive(Serialize, Deserialize)]
pub enum Event {
    Increment,
    Decrement,
    Reset,
}

#[derive(Default)]
pub struct Model {
    count: isize,
}

#[derive(Serialize, Deserialize)]
pub struct ViewModel {
    pub count: String,
}

#[derive(Effect)]
#[effect(app = &quot;Hello&quot;)]
pub struct Capabilities {
    render: Render&lt;Event&gt;,
}

#[derive(Default)]
pub struct Hello;

impl App for Hello {
    type Event = Event;
    type Model = Model;
    type ViewModel = ViewModel;
    type Capabilities = Capabilities;

    fn update(&amp;self, event: Self::Event, model: &amp;mut Self::Model, caps: &amp;Self::Capabilities) {
        match event {
            Event::Increment =&gt; model.count += 1,
            Event::Decrement =&gt; model.count -= 1,
            Event::Reset =&gt; model.count = 0,
        };

        caps.render.render();
    }</code></pre>
<p>Make sure everything builds OK</p>
<pre><code class="language-sh">cargo build
</code></pre>
<h2 id="create-the-shared-types-crate"><a class="header" href="#create-the-shared-types-crate">Create the shared types crate</a></h2>
<p>This crate serves as the container for type generation for the foreign languages.</p>
<ol>
<li>
<p>Copy over the <a href="https://github.com/redbadger/crux/tree/master/examples/counter/shared_types">shared_types</a> folder from the counter example.</p>
</li>
<li>
<p>Edit the <code>build.rs</code> file and make sure to only list types you need.</p>
</li>
<li>
<p>Make sure everything builds and foreign types get generated into the <code>generated</code> folder.</p>
<pre><code class="language-sh">cargo build -vv
</code></pre>
</li>
</ol>
<div id="admonition-success" class="admonition success">
<div class="admonition-title">
<p>Success</p>
<p><a class="admonition-anchor-link" href="#admonition-success"></a></p>
</div>
<div>
<p>You should now be ready to set up <a href="ios.html">iOS</a>, <a href="android.html">Android</a>, <a href="web_react.html">web</a>, or <a href="web_yew.html">WebAssembly</a> specific builds.</p>
</div>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../motivation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../getting_started/ios.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../motivation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../getting_started/ios.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
